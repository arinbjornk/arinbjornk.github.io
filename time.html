<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Hyper-local Time</title>
    <style>
        /* ensure gradient covers full viewport and body honours safe areas */
        html,
        body {
            height: 100%;
            min-height: 100vh;
            margin: 0;
            overflow-x: hidden;
        }

        html {
            font-family: 'Avenir', 'Source Sans Pro', sans-serif;
            scroll-behaviour: smooth;
        }

        /* fluid type scale */
        :root {
            font-size: clamp(16px, 2.5vw, 24px);
        }

        h1 {
            font-size: 2rem;
            font-weight: bold;
            margin: 0;
        }

        #time {
            font-size: 3rem;
            margin: 0.5rem 0;
        }

        #location {
            font-size: 0.875rem;
            margin-bottom: 1rem;
        }

        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
            transition: background 1s linear;
        }

        footer {
            position: fixed;
            bottom: env(safe-area-inset-bottom, 0);
            left: 0;
            right: 0;
            text-align: center;
            font-size: 0.875rem;
            opacity: 0.6;
            pointer-events: auto;
        }

        footer a {
            color: inherit;
            text-decoration: none;
        }
    </style>
</head>

<body>
    <h1>Hyper-local Time</h1>
    <div id="time">--:--:--</div>
    <div id="location">Awaiting location…</div>

    <footer>
        <a href="https://arinbjorn.is" rel="noopener">arinbjorn.is</a>
    </footer>

    <script>
        // — Helpers for solar geometry —
        const dayOfYear = d => Math.floor((d - new Date(d.getFullYear(), 0, 0)) / 864e5);
        const solarDeclination = n =>
            23.44 * Math.sin(2 * Math.PI * (n - 81) / 365) * Math.PI / 180;
        const solarElevation = (φ, δ, H) =>
            Math.asin(
                Math.sin(φ) * Math.sin(δ) +
                Math.cos(φ) * Math.cos(δ) * Math.cos(H)
            );

        let latitude, longitude, intervalId;

        function startClock() {
            const nowUTC = new Date();
            const solarOffsetMs = longitude * 4 * 60 * 1000;
            const solarTime = new Date(nowUTC.getTime() + solarOffsetMs);

            // Format HH:MM:SS
            const hh = solarTime.getUTCHours().toString().padStart(2, '0');
            const mm = solarTime.getUTCMinutes().toString().padStart(2, '0');
            const ss = solarTime.getUTCSeconds().toString().padStart(2, '0');
            document.getElementById('time').textContent = `${hh}:${mm}:${ss}`;

            // Solar elevation → background luminance
            const N = dayOfYear(solarTime);
            const δ = solarDeclination(N);
            const φ = latitude * Math.PI / 180;
            const H = ((solarTime.getUTCHours() + solarTime.getUTCMinutes() / 60) - 12)
                * 15 * Math.PI / 180;
            const elev = solarElevation(φ, δ, H);
            const L = Math.max(0, Math.sin(elev));  // 0 (night) → 1 (sun overhead)

            // Background gradient on <html>
            const topL = 10 + 40 * L;
            const botL = 30 + 40 * L;
            document.documentElement.style.background =
                `linear-gradient(to bottom,
           hsl(200,60%,${topL}%),
           hsl(200,60%,${botL}%)
         )`;

            // Pick text colour for contrast and apply to all text elements
            const avgL = (topL + botL) / 2;
            const txt = avgL > 50 ? '#252525' : '#ffffff';
            document.querySelectorAll('h1, #time, #location, footer a')
                .forEach(el => el.style.color = txt);
        }

        // — GPS polling every 30 seconds —
        const HIGH_OPTS = {
                enableHighAccuracy: true,
                maximumAge: 0,
                timeout: 15_000
            };

            const LOW_OPTS = {
                enableHighAccuracy: false,    // allow IP-based lookup
                maximumAge: 300_000,    // you can cache up to 5 min
                timeout: 10_000
            };

            function requestFix() {
                // ① Try high‐accuracy first
                navigator.geolocation.getCurrentPosition(updatePos, err => {
                    if (err.code === err.POSITION_UNAVAILABLE) {
                        // ② fallback to low‐accuracy if high‐accuracy fails
                        console.warn('High-accuracy fix failed, falling back to low accuracy');
                        navigator.geolocation.getCurrentPosition(updatePos, handleErr, LOW_OPTS);
                    } else {
                        handleErr(err);
                    }
                }, HIGH_OPTS);
            }

            // Kick off and repeat every 30 s
            requestFix();
            setInterval(requestFix, 30_000);
    </script>
</body>

</html>